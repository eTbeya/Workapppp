<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–î–∏—Å—Ç—Ä–∏–±—É—Ç–æ—Ä ‚Äì –ö–æ–Ω—Ç—Ä–æ–ª</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --card-2:#fcfdff; --border:#e6eaf2;
      --text:#0f172a; --muted:#6b7280; --accent:#2563eb; --success:#16a34a;
      --warning:#d97706; --danger:#dc2626; --purple:#7c3aed; --ring: rgba(37,99,235,.25);
    }
    html,body{background:var(--bg); color:var(--text); -webkit-tap-highlight-color: transparent;}
    .app-header{position:sticky; top:0; z-index:40; background:linear-gradient(180deg,#fff,rgba(255,255,255,.9)); backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid var(--border)}
    .title h1{font-size:1.05rem; margin:0; font-weight:700; letter-spacing:.2px}
    .toolbar{display:flex; gap:.4rem; flex-wrap:nowrap}
    .btn-ico{--size:36px;width:var(--size);height:var(--size);display:inline-flex;align-items:center;justify-content:center;border-radius:12px;border:1px solid var(--border);background:#f6f9ff;font-weight:800;letter-spacing:.3px;font-size:.9rem;color:#1f2937;box-shadow:0 1px 0 rgba(15,23,42,.04),0 1px 8px rgba(15,23,42,.06);transition:transform .07s,box-shadow .15s,background .2s}
    .btn-ico:active{transform:translateY(1px)}
    .btn-ico[data-variant="pri"]{color:#0b3bdb;border-color:#dae6ff;background:linear-gradient(180deg,#eef4ff,#e9f1ff)}
    .btn-ico[data-variant="succ"]{color:#046b38;border-color:#d8f1e4;background:linear-gradient(180deg,#ecfff6,#e7fdf2)}
    .btn-ico[data-variant="mut"]{color:#334155;border-color:#e8eef6;background:linear-gradient(180deg,#f6f9ff,#f2f6fd)}
    .btn-ico[data-variant="destr"]{color:#9f1239;border-color:#ffd7df;background:linear-gradient(180deg,#fff0f3,#ffe8ec)}
    .card{background:var(--card); border:1px solid var(--border); border-radius:18px; box-shadow:0 8px 30px rgba(15,23,42,.04)}
    .section-title{display:flex; align-items:center; gap:.5rem; margin-bottom:.25rem}
    .section-title .dot{width:10px; height:10px; border-radius:50%; background:var(--accent)}
    .chip{background:#eef4ff; color:#2445b5; padding:.2rem .45rem; border-radius:999px; font-weight:700; font-size:.8rem}
    .muted{color:var(--muted)}
    .shop-card{border-radius:14px; border:1px solid var(--border); background:var(--card-2)}
    .shop-header{display:flex; align-items:center; justify-content:space-between; gap:.5rem; padding:.7rem .85rem; cursor:pointer;}
    .shop-title{display:flex; flex-direction:column; min-width:0}
    .shop-title .name{font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .shop-title .meta{font-size:.82rem; color:var(--muted); font-variant-numeric:tabular-nums}
    .shop-actions{display:flex; gap:.35rem}
    .shop-actions .btn{border-radius:10px}
    .shop-body{padding:.9rem .85rem 1rem .85rem; border-top:1px dashed var(--border)}
    .grid-compact{display:grid; grid-template-columns:1fr 1fr; gap:.7rem}
    .grid-compact .full{grid-column:1 / -1}
    .form-control,.form-select{border-radius:12px; border:1px solid var(--border); background:#fff}
    .form-control:focus{box-shadow:0 0 0 .25rem var(--ring); border-color:#cfe0ff}
    .table{--bs-table-bg:transparent; --bs-table-striped-bg:#f9fbff}
    .table thead th{position:sticky; top:0; background:#fff; z-index:1; border-bottom:1px solid var(--border)}
    .table tbody td{border-top:1px solid var(--border)}
    .table-striped>tbody>tr:nth-of-type(odd)>*{background:var(--bs-table-striped-bg)}
    .table .text-end{font-variant-numeric:tabular-nums}
    .totals-col{display:grid; gap:.35rem; justify-items:end; font-variant-numeric:tabular-nums}
    .totals-col .line{display:flex; gap:.5rem}
    .totals-col .line strong{min-width:110px; text-align:right}
    .toastx{position:fixed; left:50%; bottom:18px; transform:translateX(-50%); background:#111827; color:#fff; padding:.55rem .8rem; border-radius:10px; box-shadow:0 8px 28px rgba(0,0,0,.2); z-index:9999; font-size:.95rem}
    @media (max-width:480px){.btn-ico{--size:34px;font-size:.85rem;border-radius:10px}.title h1{font-size:1rem}.grid-compact{grid-template-columns:1fr 1fr}.shop-header{padding:.6rem .7rem}.shop-body{padding:.8rem .7rem 1rem}.card{border-radius:16px}}
  </style>
</head>
<body>
  <div class="app-header">
    <div class="container py-2 d-flex align-items-center justify-content-between">
      <div class="toolbar">
        <button class="btn-ico" title="–ú–∞–≥–∞–∑–∏–Ω–∏" aria-label="–ú–∞–≥–∞–∑–∏–Ω–∏" data-scroll="#shops">–ú</button>
        <button class="btn-ico" title="–î–æ—Å—Ç–∞–≤–∫–∞" aria-label="–î–æ—Å—Ç–∞–≤–∫–∞" data-scroll="#delivery" data-variant="pri">–î</button>
        <button class="btn-ico" title="–ë—Ä–∞–∫ (–æ–±–∏–∫–æ–ª–∫–∞)" aria-label="–ë—Ä–∞–∫" data-scroll="#waste">–ë–û</button>
        <button class="btn-ico" title="–†–∞–∑—Ö–æ–¥–∏" aria-label="–†–∞–∑—Ö–æ–¥–∏" data-scroll="#expenses">–†</button>
        <button class="btn-ico" title="–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏ –¥–Ω–∏" aria-label="–î–Ω–∏" data-scroll="#days" data-variant="succ">–î–Ω</button>
        <button class="btn-ico" title="–°–µ–¥–º–∏—Ü–∏ (–ü–æ–Ω‚Äì–ü–µ—Ç)" aria-label="–°–µ–¥–º–∏—Ü–∏" data-scroll="#weeks" data-variant="mut">–°</button>
        <button id="exportBtn" class="btn-ico" title="–ï–∫—Å–ø–æ—Ä—Ç" aria-label="–ï–∫—Å–ø–æ—Ä—Ç" data-variant="pri">–ï–ö</button>
        <label class="btn-ico d-inline-flex align-items-center justify-content-center" title="–ò–º–ø–æ—Ä—Ç" aria-label="–ò–º–ø–æ—Ä—Ç" style="cursor:pointer;">–ò–ú
          <input id="importInput" type="file" accept=".json" hidden>
        </label>
        <button id="toggleAutoBackup" class="btn-ico" title="–ê–≤—Ç–æ –±–µ–∫—ä–ø ON/OFF" aria-pressed="false">–ê–ë</button>
        <button id="resetAll" class="btn-ico" title="–ù—É–ª–∏—Ä–∞–π" aria-label="–ù—É–ª–∏—Ä–∞–π" data-variant="destr">–ù–£</button>
      </div>
    </div>
  </div>

  <main class="container py-3">
    <!-- –ú–∞–≥–∞–∑–∏–Ω–∏ -->
    <section id="shops" class="card mb-4">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="section-title"><span class="dot"></span><h2 class="h6 m-0">–ú–∞–≥–∞–∑–∏–Ω–∏</h2><span class="chip">–∞–≤—Ç–æ-–∫—Ä–∞–µ–Ω</span></div>
          <div class="d-flex gap-2">
            <button id="addShop" class="btn btn-sm btn-primary">+ –ú–∞–≥–∞–∑–∏–Ω</button>
            <button id="endDay" class="btn btn-sm btn-warning">–ü—Ä–∏–∫–ª—é—á–∏</button>
          </div>
        </div>
        <div id="shopsList" class="d-flex flex-column gap-2"></div>

        <!-- –î–Ω–µ–≤–Ω–∏ —Ç–æ—Ç–∞–ª–∏ (–∂–∏–≤–∏) -->
        <div class="mt-3">
          <div class="totals-col">
            <div class="line"><span class="muted">–ö—Ä–∞–µ–Ω (–º–∞–≥–∞–∑–∏–Ω–∏):</span><strong id="totalShopsNet">0.00 –ª–≤.</strong></div>
            <div class="line"><span class="muted">–ú–∏–Ω—É—Å —Ä–∞–∑—Ö–æ–¥–∏ –¥–Ω–µ—Å:</span><strong id="totalOutflowsToday">0.00 –ª–≤.</strong></div>
            <div class="line"><span>–ö—Ä–∞–µ–Ω –∑–∞ –¥–µ–Ω—è:</span><strong id="totalFinalToday">0.00 –ª–≤.</strong></div>
          </div>
        </div>
      </div>
    </section>

    <!-- –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏ –¥–Ω–∏ -->
    <section id="days" class="card mb-4">
      <div class="card-body">
        <div class="section-title mb-2"><span class="dot" style="background:var(--success)"></span><h2 class="h6 m-0">–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏ –¥–Ω–∏</h2></div>
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>–î–∞—Ç–∞</th>
                <th class="text-end">–û–±–æ—Ä–æ—Ç</th>
                <th class="text-end">–ë—Ä–∞–∫ (–º–∞–≥–∞–∑–∏–Ω–∏)</th>
                <th class="text-end">–†–∞–∑—Ö–æ–¥–∏</th>
                <th class="text-end">–ö—Ä–∞–µ–Ω</th>
                <th class="text-end">–î–µ—Ç–∞–π–ª–∏</th>
                <th class="text-end">–î–µ–π—Å—Ç–≤–∏–µ</th>
              </tr>
            </thead>
            <tbody id="daysTbody"><tr><td colspan="7" class="muted">–ù—è–º–∞ –¥–∞–Ω–Ω–∏.</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- –°–µ–¥–º–∏—Ü–∏ (–ü–æ–Ω‚Äì–ü–µ—Ç) -->
    <section id="weeks" class="card mb-4">
      <div class="card-body">
        <div class="section-title mb-2"><span class="dot" style="background:var(--accent)"></span><h2 class="h6 m-0">–°–µ–¥–º–∏—á–Ω–∏ —Å—É–º–∏ (–ü–æ–Ω‚Äì–ü–µ—Ç)</h2></div>
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead><tr><th>–°–µ–¥–º–∏—Ü–∞</th><th class="text-end">–û–±—â–æ –æ–±–æ—Ä–æ—Ç</th><th class="text-end">–û–±—â–æ –±—Ä–∞–∫</th><th class="text-end">–û–±—â–æ –∫—Ä–∞–µ–Ω</th></tr></thead>
            <tbody id="weeksTbody"><tr><td colspan="4" class="muted">–ù—è–º–∞ –¥–∞–Ω–Ω–∏.</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- –î–æ—Å—Ç–∞–≤–∫–∞ -->
    <section id="delivery" class="card mb-4">
      <div class="card-body">
        <div class="section-title mb-3"><span class="dot" style="background:var(--warning)"></span><h2 class="h6 m-0">–î–æ—Å—Ç–∞–≤–∫–∞</h2></div>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card"><div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2"><div><div class="fw-semibold">–ë–∞–∑–ª–º–∞</div><div class="muted small">–§–∏–∫—Å–∏—Ä–∞–Ω–∞ —Ü–µ–Ω–∞</div></div><span class="badge text-bg-primary">1,55 –ª–≤.</span></div>
              <div class="row g-2">
                <div class="col-6"><label class="form-label">–ë—Ä–æ–π</label><input id="qtyBaz" type="number" min="0" step="1" inputmode="numeric" class="form-control form-control-lg" placeholder="0"></div>
                <div class="col-6"><label class="form-label">–°—É–º–∞</label><input id="sumBaz" type="text" class="form-control form-control-lg" value="0.00" readonly></div>
              </div>
            </div></div>
          </div>
          <div class="col-md-6">
            <div class="card"><div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2"><div><div class="fw-semibold">–ú–∏–Ω–∏ –±–∞–∑–ª–º–∞</div><div class="muted small">–§–∏–∫—Å–∏—Ä–∞–Ω–∞ —Ü–µ–Ω–∞</div></div><span class="badge text-bg-primary">0,55 –ª–≤.</span></div>
              <div class="row g-2">
                <div class="col-6"><label class="form-label">–ë—Ä–æ–π</label><input id="qtyMini" type="number" min="0" step="1" inputmode="numeric" class="form-control form-control-lg" placeholder="0"></div>
                <div class="col-6"><label class="form-label">–°—É–º–∞</label><input id="sumMini" type="text" class="form-control form-control-lg" value="0.00" readonly></div>
              </div>
            </div></div>
          </div>
        </div>
        <hr class="my-3">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="fs-6">–ö—Ä–∞–π–Ω–∞ —Å—É–º–∞: <strong id="deliveryTotal">0.00 –ª–≤.</strong></div>
          <div class="d-flex gap-2">
            <button id="finalizeDelivery" class="btn btn-sm btn-success">–ü—Ä–∏–∫–ª—é—á–∏</button>
            <button id="clearDelivery" class="btn btn-sm btn-outline-secondary">–ò–∑—á–∏—Å—Ç–∏</button>
          </div>
        </div>
      </div>
    </section>

    <!-- –ë—Ä–∞–∫ (–æ–±–∏–∫–æ–ª–∫–∞) -->
    <section id="waste" class="card mb-4">
      <div class="card-body">
        <div class="section-title mb-3"><span class="dot" style="background:var(--purple)"></span><h2 class="h6 m-0">–ë—Ä–∞–∫ (–æ–±–∏–∫–æ–ª–∫–∞)</h2></div>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card"><div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2"><div><div class="fw-semibold">–ë–∞–∑–ª–º–∞ ‚Äì –ë—Ä–∞–∫</div><div class="muted small">–§–∏–∫—Å–∏—Ä–∞–Ω–∞ —Ü–µ–Ω–∞</div></div><span class="badge text-bg-secondary">1,55 –ª–≤.</span></div>
              <div class="row g-2">
                <div class="col-6"><label class="form-label">–ë—Ä–æ–π</label><input id="qtyBazWaste" type="number" min="0" step="1" inputmode="numeric" class="form-control form-control-lg" placeholder="0"></div>
                <div class="col-6"><label class="form-label">–°—É–º–∞</label><input id="sumBazWaste" type="text" class="form-control form-control-lg" value="0.00" readonly></div>
              </div>
            </div></div>
          </div>
          <div class="col-md-6">
            <div class="card"><div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2"><div><div class="fw-semibold">–ú–∏–Ω–∏ –±–∞–∑–ª–º–∞ ‚Äì –ë—Ä–∞–∫</div><div class="muted small">–§–∏–∫—Å–∏—Ä–∞–Ω–∞ —Ü–µ–Ω–∞</div></div><span class="badge text-bg-secondary">0,55 –ª–≤.</span></div>
              <div class="row g-2">
                <div class="col-6"><label class="form-label">–ë—Ä–æ–π</label><input id="qtyMiniWaste" type="number" min="0" step="1" inputmode="numeric" class="form-control form-control-lg" placeholder="0"></div>
                <div class="col-6"><label class="form-label">–°—É–º–∞</label><input id="sumMiniWaste" type="text" class="form-control form-control-lg" value="0.00" readonly></div>
              </div>
            </div></div>
          </div>
        </div>
        <hr class="my-3">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="fs-6">–û–±—â–æ –±—Ä–∞–∫: <strong id="wasteTotal">0.00 –ª–≤.</strong></div>
          <div class="d-flex gap-2">
            <button id="finalizeWaste" class="btn btn-sm btn-outline-dark">–î–æ–±–∞–≤–∏</button>
            <button id="clearWaste" class="btn btn-sm btn-outline-secondary">–ò–∑—á–∏—Å—Ç–∏</button>
          </div>
        </div>
      </div>
    </section>

    <!-- –†–∞–∑—Ö–æ–¥–∏ (–∏–∑–≤—ä–Ω –º–∞–≥–∞–∑–∏–Ω–∏) -->
    <section id="expenses" class="card mb-4">
      <div class="card-body">
        <div class="section-title mb-2"><span class="dot" style="background:var(--danger)"></span><h2 class="h6 m-0">–†–∞–∑—Ö–æ–¥–∏</h2></div>
        <div class="row g-2 align-items-end">
          <div class="col-7 col-sm-8">
            <label class="form-label">–ò–º–µ/–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <input id="expName" type="text" class="form-control" placeholder="–ó–∞–ø–ª–∞—Ç–∞, –≥–æ—Ä–∏–≤–æ, –¥—Ä.">
          </div>
          <div class="col-5 col-sm-4">
            <label class="form-label">–°—É–º–∞ (–ª–≤.)</label>
            <input id="expAmount" type="number" inputmode="decimal" step="0.01" min="0" class="form-control" placeholder="0.00">
          </div>
        </div>
        <div class="mt-2 d-flex gap-2">
          <button id="addExpense" class="btn btn-sm btn-danger">–î–æ–±–∞–≤–∏ —Ä–∞–∑—Ö–æ–¥</button>
          <span class="muted small">* —Å—É–º–∞—Ç–∞ —Å–µ –≤–∞–¥–∏ –æ—Ç ‚Äû–ö—Ä–∞–µ–Ω –∑–∞ –¥–µ–Ω—è‚Äú</span>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-striped align-middle">
            <thead><tr><th>–î–∞—Ç–∞</th><th>–ò–º–µ</th><th class="text-end">–°—É–º–∞</th><th class="text-end">–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
            <tbody id="expensesTbody"><tr><td colspan="4" class="muted">–ù—è–º–∞ —Ä–∞–∑—Ö–æ–¥–∏.</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- –ò—Å—Ç–æ—Ä–∏–∏: –¥–æ—Å—Ç–∞–≤–∫–∏ -->
    <section class="card mb-4">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="section-title"><span class="dot" style="background:var(--accent)"></span><h2 class="h6 m-0">–°–ø–∏—Å—ä–∫ —Å –¥–æ—Å—Ç–∞–≤–∫–∏</h2></div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead><tr><th>–î–∞—Ç–∞</th><th class="text-end">–ë–∞–∑–ª–º–∞ (–±—Ä.)</th><th class="text-end">–ú–∏–Ω–∏ (–±—Ä.)</th><th class="text-end">–°—É–º–∞ (–ª–≤.)</th><th class="text-end">–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
            <tbody id="deliveriesTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- –ò—Å—Ç–æ—Ä–∏–∏: –±—Ä–∞–∫–æ–≤–µ -->
    <section class="card mb-5">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="section-title"><span class="dot" style="background:var(--purple)"></span><h2 class="h6 m-0">–°–ø–∏—Å—ä–∫ —Å –±—Ä–∞–∫–æ–≤–µ</h2></div>
        </div>
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead><tr><th>–î–∞—Ç–∞</th><th class="text-end">–ë–∞–∑–ª–º–∞ (–±—Ä.)</th><th class="text-end">–ú–∏–Ω–∏ (–±—Ä.)</th><th class="text-end">–°—É–º–∞</th><th class="text-end">–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
            <tbody id="wastesTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Day details modal -->
  <div class="modal fade" id="dayDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–î–µ—Ç–∞–π–ª–∏ –∑–∞ –¥–µ–Ω—è</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞—Ç–≤–æ—Ä–∏"></button>
        </div>
        <div class="modal-body">
          <div id="dayDetailsSummary" class="mb-2 small text-muted"></div>
          <div id="dayDetailsBody"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">–ó–∞—Ç–≤–æ—Ä–∏</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  (() => {
    const PRICE_BAZ=1.65, PRICE_MINI=0.55;

    // Tiny toast
    function toast(msg, ms=1600){
      try{
        const t=document.createElement('div'); t.className='toastx'; t.textContent=msg;
        document.body.appendChild(t); setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .25s'; }, ms-250);
        setTimeout(()=> t.remove(), ms);
      }catch(e){ alert(msg); }
    }

    // DOM refs
    const shopsList=document.getElementById('shopsList');
    const addShopBtn=document.getElementById('addShop');
    const endDayBtn=document.getElementById('endDay');

    const totalShopsNetEl=document.getElementById('totalShopsNet');
    const totalOutflowsTodayEl=document.getElementById('totalOutflowsToday');
    const totalFinalTodayEl=document.getElementById('totalFinalToday');

    const daysTbody=document.getElementById('daysTbody');
    const weeksTbody=document.getElementById('weeksTbody');

    const qtyBaz=document.getElementById('qtyBaz');
    const qtyMini=document.getElementById('qtyMini');
    const sumBaz=document.getElementById('sumBaz');
    const sumMini=document.getElementById('sumMini');
    const deliveryTotal=document.getElementById('deliveryTotal');

    const qtyBazWaste=document.getElementById('qtyBazWaste');
    const qtyMiniWaste=document.getElementById('qtyMiniWaste');
    const sumBazWaste=document.getElementById('sumBazWaste');
    const sumMiniWaste=document.getElementById('sumMiniWaste');
    const wasteTotal=document.getElementById('wasteTotal');
    const wastesTbody=document.getElementById('wastesTbody');

    const deliveriesTbody=document.getElementById('deliveriesTbody');

    const exportBtn=document.getElementById('exportBtn');
    const importInput=document.getElementById('importInput');
    const resetAllBtn=document.getElementById('resetAll');
    const toggleAutoBackupBtn=document.getElementById('toggleAutoBackup');

    // Expenses
    const expName=document.getElementById('expName');
    const expAmount=document.getElementById('expAmount');
    const addExpenseBtn=document.getElementById('addExpense');
    const expensesTbody=document.getElementById('expensesTbody');

    // State
    let shops=load('shops',[]);
    let deliveries=load('deliveries',[]);
    let days=load('days',[]);
    let wastes=load('wastes',[]);
    let expenses=load('expenses',[]);
    let autoBackup=load('autoBackup', false); // ON/OFF

    // Utils
    function load(k,f){ try{const r=localStorage.getItem(k); return r?JSON.parse(r):f;}catch{return f;} }
    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
    function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }
    function money(n){ return fmt(n)+' –ª–≤.'; }
    function num(v){ if(v===null||v===undefined) return 0; const s=String(v).trim().replace(/\s+/g,'').replace(',', '.'); if(s==='') return 0; const n=parseFloat(s); return isNaN(n)?0:n; }
    const now=()=>new Date();
    const nowBG=()=> now().toLocaleString('bg-BG');
    const isoDate=d=> d.toISOString().slice(0,10);
    function parseBGorISO(str){ const m=/(\d{1,2})\.(\d{1,2})\.(\d{4})/.exec(str||''); if(m){ const [_,dd,mm,yyyy]=m; return new Date(`${yyyy}-${mm}-${dd}T00:00:00`);} const d=new Date(str); return isNaN(d)? new Date(): d; }
    function dayToDate(d){ if(d.ts) return new Date(d.ts); if(d.isoDate) return new Date(d.isoDate); if(d.date) return parseBGorISO(d.date); return new Date(); }
    function weekKeyMonFri(ts){ const d=new Date(ts); const w=(d.getDay()+6)%7; const mon=new Date(d); mon.setHours(0,0,0,0); mon.setDate(d.getDate()-w); const fri=new Date(mon); fri.setDate(mon.getDate()+4); return `${isoDate(mon)} ‚Üí ${isoDate(fri)}`; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function attachInputUX(el){ el.addEventListener('focus', e=>e.target.select()); el.addEventListener('beforeinput', e=>{ if(e.inputType==='insertText' && e.target.value==='0'){ e.target.value=''; } }); }
    function smoothScrollTo(sel){ const el=document.querySelector(sel); if(el) el.scrollIntoView({behavior:'smooth', block:'start'}); }
    document.querySelectorAll('.btn-ico[data-scroll]').forEach(btn=>btn.addEventListener('click', ()=>smoothScrollTo(btn.getAttribute('data-scroll'))));

    // Auto-backup UI
    function setAutoBackupUI(){
      if(!toggleAutoBackupBtn) return;
      toggleAutoBackupBtn.setAttribute('aria-pressed', autoBackup ? 'true' : 'false');
      toggleAutoBackupBtn.dataset.variant = autoBackup ? 'succ' : 'mut';
      toggleAutoBackupBtn.title = autoBackup ? '–ê–≤—Ç–æ –±–µ–∫—ä–ø: –í–ö–õ.' : '–ê–≤—Ç–æ –±–µ–∫—ä–ø: –ò–ó–ö–õ.';
    }

    // Shops UI
    function addShopCard(data={name:'', turnover:'', waste:'', note:''}){
      const card=document.createElement('div');
      card.className='shop-card';
      card.innerHTML=`
        <div class="shop-header" data-role="toggle">
          <div class="shop-title">
            <div class="name">${escapeHtml(data.name||'–ú–∞–≥–∞–∑–∏–Ω')}</div>
            <div class="meta">–ö—Ä–∞–µ–Ω: <span class="meta-net">0.00 –ª–≤.</span></div>
          </div>
          <div class="shop-actions">
            <button class="btn btn-sm btn-outline-danger" data-role="delete" title="–ò–∑—Ç—Ä–∏–π">–ò–∑—Ç—Ä–∏–π</button>
            <button class="btn btn-sm btn-outline-secondary" data-role="collapse" title="–°–≥—ä–Ω–∏">‚ñ≤</button>
          </div>
        </div>
        <div class="shop-body">
          <div class="grid-compact">
            <div>
              <label class="form-label">–ò–º–µ</label>
              <input type="text" class="form-control shop-name" placeholder="–ú–∞–≥–∞–∑–∏–Ω –•" value="${escapeHtml(data.name||'')}">
            </div>
            <div>
              <label class="form-label">–ë–µ–ª–µ–∂–∫–∞</label>
              <input type="text" class="form-control shop-note" placeholder="–ë–µ–ª–µ–∂–∫–∞‚Ä¶" value="${escapeHtml(data.note||'')}">
            </div>
            <div>
              <label class="form-label">–û–±–æ—Ä–æ—Ç (–ª–≤.)</label>
              <input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" class="form-control shop-turnover" placeholder="0.00" value="${data.turnover===0?'':(data.turnover??'')}">
            </div>
            <div>
              <label class="form-label">–ë—Ä–∞–∫ (–ª–≤.)</label>
              <input type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" class="form-control shop-waste" placeholder="0.00" value="${data.waste===0?'':(data.waste??'')}">
            </div>
            <div class="full"><div class="muted small">–ö—Ä–∞–µ–Ω = –û–±–æ—Ä–æ—Ç ‚àí –ë—Ä–∞–∫</div></div>
          </div>
        </div>`;
      shopsList.appendChild(card);

      const nameI=card.querySelector('.shop-name');
      const noteI=card.querySelector('.shop-note');
      const turnI=card.querySelector('.shop-turnover');
      const wasteI=card.querySelector('.shop-waste');
      [turnI,wasteI].forEach(attachInputUX);

      const updateHeader=()=>{
        const t=num(turnI.value);
        const w=num(wasteI.value);
        const net=Math.max(0,t-w);
        card.querySelector('.meta-net').textContent=money(net);
        card.querySelector('.shop-title .name').textContent=(nameI.value||'–ú–∞–≥–∞–∑–∏–Ω');
        syncShops(); recomputeTotalsToday();
      };
      nameI.addEventListener('input', updateHeader);
      noteI.addEventListener('input', updateHeader);
      turnI.addEventListener('input', updateHeader);
      wasteI.addEventListener('input', updateHeader);

      // collapse
      const header=card.querySelector('[data-role="toggle"]');
      const btnCollapse=card.querySelector('[data-role="collapse"]');
      const body=card.querySelector('.shop-body');
      let collapsed=false;
      const setCollapsed=v=>{collapsed=v; body.style.display=collapsed?'none':''; btnCollapse.textContent=collapsed?'‚ñº':'‚ñ≤';};
      header.addEventListener('click', e=>{ if(e.target.closest('button')) return; setCollapsed(!collapsed); });
      btnCollapse.addEventListener('click', ()=> setCollapsed(!collapsed));
      Array.from(shopsList.children).forEach(c=>{ if(c!==card){ const b=c.querySelector('.shop-body'); const btn=c.querySelector('[data-role="collapse"]'); if(b){ b.style.display='none'; if(btn) btn.textContent='‚ñº'; } }});
      setCollapsed(false);
      updateHeader();
    }

    shopsList.addEventListener('click', (e)=>{
      const del=e.target.closest('[data-role="delete"]');
      if(del){ const card=del.closest('.shop-card'); if(card){ card.remove(); syncShops(); recomputeTotalsToday(); } }
    });

    function syncShops(){
      shops=Array.from(shopsList.querySelectorAll('.shop-card')).map(card=>({
        name: card.querySelector('.shop-name').value.trim(),
        turnover: num(card.querySelector('.shop-turnover').value),
        waste: num(card.querySelector('.shop-waste').value),
        note: card.querySelector('.shop-note').value.trim()
      })); save('shops',shops);
    }

    function renderShops(){ shopsList.innerHTML=''; shops.forEach(addShopCard); recomputeTotalsToday(); }

    // Deliveries
    function updateDeliverySums(){
      const qB=Math.max(0, parseInt(qtyBaz.value||0,10));
      const qM=Math.max(0, parseInt(qtyMini.value||0,10));
      const sB=qB*PRICE_BAZ, sM=qM*PRICE_MINI;
      sumBaz.value=fmt(sB); sumMini.value=fmt(sM); deliveryTotal.textContent=money(sB+sM);
    }
    function addDeliveryRow(d,i){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${d.date}</td><td class="text-end">${d.qtyBaz}</td><td class="text-end">${d.qtyMini}</td><td class="text-end">${fmt(d.total)} –ª–≤.</td><td class="text-end"><button class="btn btn-sm btn-outline-danger" data-i="${i}">–ò–∑—Ç—Ä–∏–π</button></td>`;
      tr.querySelector('button').addEventListener('click',(e)=>{ const idx=+e.currentTarget.getAttribute('data-i'); deliveries.splice(idx,1); save('deliveries',deliveries); renderDeliveries(); });
      deliveriesTbody.appendChild(tr);
    }
    function renderDeliveries(){ deliveriesTbody.innerHTML=''; deliveries.forEach(addDeliveryRow); }

    // Wastes (–æ–±–∏–∫–æ–ª–∫–∞) ‚Äì —Å–∞–º–æ –∏—Å—Ç–æ—Ä–∏—è, –Ω–µ –≤–ª–∏—è–µ –Ω–∞ ‚Äû–ö—Ä–∞–µ–Ω –∑–∞ –¥–µ–Ω—è‚Äú
    function updateWasteSums(){
      const qB=Math.max(0, parseInt(qtyBazWaste.value||0,10));
      const qM=Math.max(0, parseInt(qtyMiniWaste.value||0,10));
      const sB=qB*PRICE_BAZ, sM=qM*PRICE_MINI;
      sumBazWaste.value=fmt(sB); sumMiniWaste.value=fmt(sM); wasteTotal.textContent=money(sB+sM);
    }
    function addWasteRow(w,i){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${w.date}</td><td class="text-end">${w.qtyBaz}</td><td class="text-end">${w.qtyMini}</td><td class="text-end">${fmt(w.total)} –ª–≤.</td><td class="text-end"><button class="btn btn-sm btn-outline-danger" data-i="${i}">–ò–∑—Ç—Ä–∏–π</button></td>`;
      tr.querySelector('button').addEventListener('click',(e)=>{ const idx=+e.currentTarget.getAttribute('data-i'); wastes.splice(idx,1); save('wastes',wastes); renderWastes(); });
      wastesTbody.appendChild(tr);
    }
    function renderWastes(){ wastesTbody.innerHTML=''; wastes.forEach(addWasteRow); }

    // Expenses
    function addExpenseRow(x,i){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${x.date}</td><td>${escapeHtml(x.name||'-')}</td><td class="text-end">${money(x.amount||0)}</td><td class="text-end"><button class="btn btn-sm btn-outline-danger" data-i="${i}">–ò–∑—Ç—Ä–∏–π</button></td>`;
      tr.querySelector('button').addEventListener('click',(e)=>{ const idx=+e.currentTarget.getAttribute('data-i'); expenses.splice(idx,1); save('expenses',expenses); renderExpenses(); recomputeTotalsToday(); });
      expensesTbody.appendChild(tr);
    }
    function renderExpenses(){
      expensesTbody.innerHTML='';
      if(!expenses.length){ expensesTbody.innerHTML='<tr><td colspan="4" class="muted">–ù—è–º–∞ —Ä–∞–∑—Ö–æ–¥–∏.</td></tr>'; return; }
      expenses.forEach(addExpenseRow);
    }

    // Totals today (live) ‚Äî —Å–∞–º–æ —Ä–∞–∑—Ö–æ–¥–∏—Ç–µ –Ω–∞–º–∞–ª—è–≤–∞—Ç –¥–Ω–µ–≤–Ω–∏—è –∫—Ä–∞–µ–Ω
    function sumShopsNet(){
      return shops.reduce((a,s)=> a + Math.max(0,(Number(s.turnover)||0) - (Number(s.waste)||0)), 0);
    }
    function isTodayIso(obj){
      const d = obj.isoDate ? new Date(obj.isoDate) : (obj.ts ? new Date(obj.ts) : null);
      if(!d) return false;
      const t = isoDate(new Date());
      return isoDate(d) === t;
    }
    function sumTodayExpenses(){
      return expenses.reduce((a,x)=> a + (isTodayIso(x)? (Number(x.amount)||0) : 0), 0);
    }
    function recomputeTotalsToday(){
      const shopNet = sumShopsNet();
      const outflows = sumTodayExpenses(); // —Å–∞–º–æ —Ä–∞–∑—Ö–æ–¥–∏
      const final = Math.max(0, shopNet - outflows);
      totalShopsNetEl.textContent = money(shopNet);
      totalOutflowsTodayEl.textContent = money(outflows);
      totalFinalTodayEl.textContent = money(final);
    }

    // ------- –ü–†–ò–ö–õ–Æ–ß–ï–ù–ò –î–ù–ò -------
    function addDayRow(d, i){
      const hasNotes = (d.shops || []).some(s => (s.note || '').trim());
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${d.date}</td>
        <td class="text-end">${money(d.turnover)}</td>
        <td class="text-end">${money(d.waste)}</td>
        <td class="text-end">${money(d.otherExpenses || 0)}</td>
        <td class="text-end"><strong>${money(d.net)}</strong></td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-secondary" data-action="day-details" data-i="${i}">
            –í–∏–∂${hasNotes ? ' üìù' : ''}
          </button>
        </td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" data-action="del-day" data-i="${i}">–ò–∑—Ç—Ä–∏–π</button>
        </td>
      `;
      daysTbody.appendChild(tr);
    }
    function renderDays(){
      daysTbody.innerHTML='';
      if(!days.length){
        daysTbody.innerHTML = '<tr><td colspan="7" class="muted">–ù—è–º–∞ –¥–∞–Ω–Ω–∏.</td></tr>';
        return;
      }
      days.forEach(addDayRow);
    }

    // –î–µ—Ç–∞–π–ª–∏ –∑–∞ –¥–µ–Ω—è -> Bootstrap –º–æ–¥–∞–ª (–≤—Å–∏—á–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∏ + –±–µ–ª–µ–∂–∫–∏)
    function showDayDetails(i){
      const d = days[i];
      const summary = `–î–∞—Ç–∞: ${d.date} ¬∑ –û–±–æ—Ä–æ—Ç: ${fmt(d.turnover)} –ª–≤. ¬∑ –ë—Ä–∞–∫: ${fmt(d.waste)} –ª–≤. ¬∑ –†–∞–∑—Ö–æ–¥–∏: ${fmt(d.otherExpenses||0)} –ª–≤. ¬∑ –ö—Ä–∞–µ–Ω: ${fmt(d.net)} –ª–≤.`;
      document.getElementById('dayDetailsSummary').textContent = summary;

      const list = (d.shops || []).map(s => {
        const note = (s.note && String(s.note).trim()) ? `<div class="text-muted">–ë–µ–ª–µ–∂–∫–∞: ${escapeHtml(s.note.trim())}</div>` : '';
        return `
          <div class="border rounded p-2 mb-2">
            <div class="fw-semibold">${escapeHtml(s.name || '‚Äî')}</div>
            <div class="small">–û–±–æ—Ä–æ—Ç: ${fmt(s.turnover)} ¬∑ –ë—Ä–∞–∫: ${fmt(s.waste)} ¬∑ –ö—Ä–∞–µ–Ω: <strong>${fmt(s.net)}</strong></div>
            ${note}
          </div>
        `;
      }).join('') || '<div class="text-muted">–ù—è–º–∞ –º–∞–≥–∞–∑–∏–Ω–∏ –∑–∞ —Ç–æ–∑–∏ –¥–µ–Ω.</div>';
      document.getElementById('dayDetailsBody').innerHTML = list;

      const modal = new bootstrap.Modal(document.getElementById('dayDetailsModal'));
      modal.show();
    }

    // End day ‚Äî –∏–∑–≤–∞–∂–¥–∞ —Å–∞–º–æ —Ä–∞–∑—Ö–æ–¥–∏—Ç–µ, –ù–ï –±—Ä–∞–∫ (–æ–±–∏–∫–æ–ª–∫–∞)
    function endDay(){
      const hasShopData=shops.some(s=>(s.name||'').length || s.turnover>0 || s.waste>0 || (s.note||'').length);
      const otherExpenses = sumTodayExpenses();
      if(!hasShopData && otherExpenses===0){
        toast('–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ –¥–µ–Ω—è.'); return;
      }
      const totals=shops.reduce((a,s)=>{
        const t=Number(s.turnover)||0, w=Number(s.waste)||0;
        a.turnover+=t; a.waste+=w; a.net+=Math.max(0,t-w); return a;
      },{turnover:0,waste:0,net:0});

      const d=now();
      const entry={
        date:d.toLocaleString('bg-BG'), isoDate:isoDate(d), ts:d.getTime(),
        turnover:+fmt(totals.turnover),
        waste:+fmt(totals.waste),
        otherExpenses:+fmt(otherExpenses),
        net:+fmt(Math.max(0, totals.net - otherExpenses)),
        shops: shops.map(s=>{
          const t=Number(s.turnover)||0, w=Number(s.waste)||0;
          return {name:s.name, turnover:+fmt(t), waste:+fmt(w), net:+fmt(Math.max(0,t-w)), note:s.note||''};
        })
      };

      // 1) –∑–∞–ø–∏—Å
      days.unshift(entry); save('days',days);
      renderDays(); renderWeeks();

      // 2) —á–∏—Å—Ç–∏–º —Ç–µ–∫—É—â–∏—è –¥–µ–Ω (–º–∞–≥–∞–∑–∏–Ω–∏ + —Å–∞–º–æ –¥–Ω–µ—à–Ω–∏ —Ä–∞–∑—Ö–æ–¥–∏)
      shops.length = 0; save('shops', shops); renderShops();
      const todayIso = isoDate(new Date());
      for (let i = expenses.length - 1; i >= 0; i--) {
        const x = expenses[i];
        const expIso = x?.isoDate ?? (x?.ts ? isoDate(new Date(x.ts)) : null);
        if (expIso === todayIso) expenses.splice(i, 1);
      }
      save('expenses', expenses); renderExpenses();

      // 3) –æ–±–Ω–æ–≤—è–≤–∞–º–µ –∂–∏–≤–∏—Ç–µ —Ç–æ—Ç–∞–ª–∏ (–∏ ‚Äû—Ç–≤—ä—Ä–¥–æ‚Äú –Ω—É–ª–∏—Ä–∞–Ω–µ)
      recomputeTotalsToday();
      if (totalOutflowsTodayEl) totalOutflowsTodayEl.textContent = '0.00 –ª–≤.';
      if (totalFinalTodayEl)    totalFinalTodayEl.textContent    = '0.00 –ª–≤.';

      // 4) –∞–≤—Ç–æ-–±–µ–∫—ä–ø –∞–∫–æ –µ –≤–∫–ª—é—á–µ–Ω
      if (autoBackup) { try { doExport(); } catch(e){ console.error('Auto backup failed:', e); } }

      // 5) –æ–±—Ä–∞—Ç–Ω–∞ –≤—Ä—ä–∑–∫–∞ + –º–∞–ª—ä–∫ UI reset (PWA –ø–æ–Ω—è–∫–æ–≥–∞ –∫–µ—à–∏—Ä–∞ DOM)
      toast('–î–µ–Ω—è—Ç –µ –ø—Ä–∏–∫–ª—é—á–µ–Ω.');
      setTimeout(()=> location.reload(), 200);
    }

    // Weeks (–ü–æ–Ω‚Äì–ü–µ—Ç)
    function renderWeeks(){
      weeksTbody.innerHTML='';
      if(!days.length){ weeksTbody.innerHTML='<tr><td colspan="4" class="muted">–ù—è–º–∞ –¥–∞–Ω–Ω–∏.</td></tr>'; return; }
      const map={};
      for(const d of days){
        const dt=dayToDate(d);
        const key=weekKeyMonFri(dt.getTime());
        if(!map[key]) map[key]={turnover:0,waste:0,net:0};
        map[key].turnover+=(Number(d.turnover)||0);
        map[key].waste+=(Number(d.waste)||0);
        map[key].net+=(Number(d.net)||0);
      }
      const rows=Object.entries(map)
        .sort((a,b)=> new Date(b[0].slice(0,10)) - new Date(a[0].slice(0,10)))
        .map(([wk,v])=>`
          <tr>
            <td>${wk}</td>
            <td class="text-end">${money(v.turnover)}</td>
            <td class="text-end">${money(v.waste)}</td>
            <td class="text-end"><strong>${money(v.net)}</strong></td>
          </tr>`).join('');
      weeksTbody.innerHTML=rows||'<tr><td colspan="4" class="muted">–ù—è–º–∞ –¥–∞–Ω–Ω–∏.</td></tr>';
    }

    // Export / Import / Reset
    function doExport(){
      const payload={version:14, exportedAt: nowBG(), shops, deliveries, days, wastes, expenses, autoBackup};
      const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`distributor-data-${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove();
    }
    function doImport(file){
      const r=new FileReader();
      r.onload=()=>{
        try{
          const data=JSON.parse(r.result);
          if(data.shops){ shops=data.shops; save('shops',shops); renderShops(); }
          if(data.deliveries){ deliveries=data.deliveries; save('deliveries',deliveries); renderDeliveries(); }
          if(data.days){ days=data.days; save('days',days); renderDays(); renderWeeks(); }
          if(data.wastes){ wastes=data.wastes; save('wastes',wastes); renderWastes(); }
          if(data.expenses){ expenses=data.expenses; save('expenses',expenses); renderExpenses(); }
          if(typeof data.autoBackup==='boolean'){ autoBackup=data.autoBackup; save('autoBackup',autoBackup); setAutoBackupUI(); }
          recomputeTotalsToday();
          toast('–ò–º–ø–æ—Ä—Ç—ä—Ç –µ –≥–æ—Ç–æ–≤.');
        }catch(e){ alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç: '+e.message); }
      };
      r.readAsText(file,'utf-8');
    }

    // –î–µ–ª–µ–≥–∏—Ä–∞–Ω–∏ –∫–ª–∏–∫–æ–≤–µ (generic)
    function onClick(selector, handler){
      document.addEventListener('click', (e)=>{
        const el=e.target.closest(selector);
        if(el){ e.preventDefault(); try{ handler(e, el); }catch(err){ console.error(err); alert('–ì—Ä–µ—à–∫–∞: '+err.message); } }
      });
    }
    onClick('[data-action="day-details"]', (e, btn)=> showDayDetails(+btn.dataset.i));
    onClick('[data-action="del-day"]', (e, btn)=>{
      const i = +btn.dataset.i;
      if(!confirm('–î–∞ –∏–∑—Ç—Ä–∏–µ–º –ª–∏ —Ç–æ–∑–∏ –¥–µ–Ω?')) return;
      days.splice(i,1); save('days', days); renderDays(); renderWeeks();
    });

    // Listeners
    addShopBtn.addEventListener('click', ()=>{ addShopCard(); syncShops(); });
    endDayBtn.addEventListener('click', endDay);

    qtyBaz.addEventListener('input', updateDeliverySums);
    qtyMini.addEventListener('input', updateDeliverySums);
    document.getElementById('finalizeDelivery').addEventListener('click', ()=>{
      const qB=Math.max(0, parseInt(qtyBaz.value||0,10));
      const qM=Math.max(0, parseInt(qtyMini.value||0,10));
      if(qB===0 && qM===0){ toast('–í—ä–≤–µ–¥–∏ –±—Ä–æ–π –∑–∞ –ø–æ–Ω–µ –µ–¥–∏–Ω –∞—Ä—Ç–∏–∫—É–ª.'); return; }
      const d=now(); const total=qB*PRICE_BAZ + qM*PRICE_MINI;
      deliveries.unshift({date:nowBG(), isoDate:isoDate(d), ts:d.getTime(), qtyBaz:qB, qtyMini:qM, total:Math.round(total*100)/100});
      save('deliveries',deliveries); renderDeliveries();
      qtyBaz.value=''; qtyMini.value=''; updateDeliverySums();
      toast('–î–æ—Å—Ç–∞–≤–∫–∞—Ç–∞ –µ –∑–∞–ø–∏—Å–∞–Ω–∞.');
    });
    document.getElementById('clearDelivery').addEventListener('click', ()=>{ qtyBaz.value=''; qtyMini.value=''; updateDeliverySums(); });

    qtyBazWaste.addEventListener('input', updateWasteSums);
    qtyMiniWaste.addEventListener('input', updateWasteSums);
    document.getElementById('clearWaste').addEventListener('click', ()=>{ qtyBazWaste.value=''; qtyMiniWaste.value=''; updateWasteSums(); });
    document.getElementById('finalizeWaste').addEventListener('click', ()=>{
      const qB=Math.max(0, parseInt(qtyBazWaste.value||0,10));
      const qM=Math.max(0, parseInt(qtyMiniWaste.value||0,10));
      if(qB===0 && qM===0){ toast('–í—ä–≤–µ–¥–∏ –±—Ä–æ–π –∑–∞ –ø–æ–Ω–µ –µ–¥–∏–Ω –∞—Ä—Ç–∏–∫—É–ª –±—Ä–∞–∫.'); return; }
      const d=now(); const total=qB*PRICE_BAZ + qM*PRICE_MINI;
      wastes.unshift({date:nowBG(), isoDate:isoDate(d), ts:d.getTime(), qtyBaz:qB, qtyMini:qM, total:Math.round(total*100)/100});
      save('wastes',wastes); renderWastes(); // –Ω–µ –≤–ª–∏—è–µ –Ω–∞ –¥–Ω–µ–≤–Ω–∏—è –∫—Ä–∞–µ–Ω
      qtyBazWaste.value=''; qtyMiniWaste.value=''; updateWasteSums();
      toast('–ë—Ä–∞–∫—ä—Ç –µ –∑–∞–ø–∏—Å–∞–Ω.');
    });

    addExpenseBtn.addEventListener('click', ()=>{
      const name=(expName.value||'').trim();
      const amount=num(expAmount.value);
      if(!name){ toast('–í—ä–≤–µ–¥–∏ –∏–º–µ/–æ–ø–∏—Å–∞–Ω–∏–µ.'); return; }
      if(amount<=0){ toast('–í—ä–≤–µ–¥–∏ —Å—É–º–∞ > 0.'); return; }
      const d=now();
      expenses.unshift({date:nowBG(), isoDate:isoDate(d), ts:d.getTime(), name, amount:+fmt(amount)});
      save('expenses',expenses); renderExpenses(); recomputeTotalsToday();
      expName.value=''; expAmount.value='';
      toast('–†–∞–∑—Ö–æ–¥—ä—Ç –µ –¥–æ–±–∞–≤–µ–Ω.');
    });

    exportBtn.addEventListener('click', doExport);
    importInput.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(f) doImport(f); e.target.value=''; });
    resetAllBtn.addEventListener('click', ()=>{
      if(!confirm('–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ –¥–∞–Ω–Ω–∏?')) return;
      shops=[]; deliveries=[]; days=[]; wastes=[]; expenses=[];
      save('shops',shops); save('deliveries',deliveries); save('days',days); save('wastes',wastes); save('expenses',expenses);
      renderShops(); renderDeliveries(); renderDays(); renderWeeks(); renderWastes(); renderExpenses();
      updateDeliverySums(); updateWasteSums(); recomputeTotalsToday();
      toast('–í—Å–∏—á–∫–æ –µ –Ω—É–ª–∏—Ä–∞–Ω–æ.');
    });

    // –ê–≤—Ç–æ-–±–µ–∫—ä–ø –±—É—Ç–æ–Ω
    if (toggleAutoBackupBtn) {
      toggleAutoBackupBtn.addEventListener('click', ()=>{
        autoBackup = !autoBackup;
        save('autoBackup', autoBackup);
        setAutoBackupUI();
        toast(autoBackup ? '–ê–≤—Ç–æ –±–µ–∫—ä–ø: –í–ö–õ.' : '–ê–≤—Ç–æ –±–µ–∫—ä–ø: –ò–ó–ö–õ.');
      });
    }

    // Init
    (function init(){
      renderShops(); renderDeliveries(); renderDays(); renderWeeks(); renderWastes(); renderExpenses();
      updateDeliverySums(); updateWasteSums(); recomputeTotalsToday();
      setAutoBackupUI();
      if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
    })();
  })();
  </script>
</body>
</html>


